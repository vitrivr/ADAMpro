syntax = "proto3";

option java_package = "ch.unibas.dmi.dbis.adam.http";


service AdamDefinition {
  rpc CreateEntity(CreateEntityMessage) returns (AckMessage) {}
  rpc DropEntity(EntityNameMessage) returns (AckMessage) {}
  rpc Insert(stream InsertMessage) returns (AckMessage) {}
  rpc Index(IndexMessage) returns (AckMessage) {}
  rpc DropIndex(IndexNameMessage) returns (AckMessage) {}
  rpc Count(EntityNameMessage) returns (AckMessage) {}
  rpc RandomData(RandomDataMessage) returns (AckMessage) {}
}

service AdamSearch {
  rpc DoStandardQuery(SimpleQueryMessage) returns (QueryResponseListMessage) {}
  rpc DoSequentialQuery(SimpleSequentialQueryMessage) returns (QueryResponseListMessage) {}
  rpc DoSpecifiedIndexQuery(SimpleSpecifiedIndexQueryMessage) returns (QueryResponseListMessage) {}
  rpc DoIndexQuery(SimpleIndexQueryMessage) returns (QueryResponseListMessage) {}
  rpc DoProgressiveQuery(SimpleQueryMessage) returns (stream QueryResponseInfoMessage) {}
  rpc DoTimedProgressiveQuery(TimedQueryMessage) returns (QueryResponseInfoMessage) {}
  rpc DoCompoundQuery(CompoundQueryMessage) returns (QueryResponseListMessage) {}
}


message CreateEntityMessage {
  string entity = 1;
  enum FieldType {
    LONG = 0;
    INT = 1;
    FLOAT = 2;
    DOUBLE = 3;
    STRING = 4;
    BOOLEAN = 5;
  }
  map<string, FieldType> fields = 2;
}

message EntityNameMessage {
  string entity = 1;
}

message IndexNameMessage {
  string entity = 1;
}

message RandomDataMessage {
  string entity = 1;
  int32 ntuples = 2;
  int32 ndims = 3;
}

message AckMessage {
  enum Code {
    OK = 0;
    ERROR = 1;
  }
  Code code = 1;
  string message = 2;
}

//insert and update (if id exists already)
message InsertMessage {
  string entity = 1;
  repeated TupleInsertMessage tuples = 2;

  message TupleInsertMessage {
    //int64 id = 1;
    repeated float vector = 2 [packed=true];
    map<string, string> metadata = 3;
  }
}



enum IndexType {
    lsh = 0;
    sh = 1;
    ecp = 2;
    vaf = 3;
    vav = 4;
}

message IndexMessage {
  string entity = 1;
  IndexType indextype = 2;
  int32 norm = 3;
  map<string, string> options = 4;
}

message NearestNeighbourQueryMessage {
  repeated float query = 1 [packed=true];
  int32 norm = 2;
  int32 k = 3;
  bool indexOnly = 4;
  map<string, string> options = 5;
}

message BooleanQueryMessage {
  repeated WhereMessage where = 2;
  repeated JoinMessage joins = 3;
  repeated int64 prefilter = 1;

  message WhereMessage {
    string field = 1;
    string value = 2;
  }

  message JoinMessage {
    string table = 1;
    repeated string columns = 2;
  }
}

message SimpleQueryMessage {
  string entity = 1;
  string hint = 2;
  NearestNeighbourQueryMessage nnq = 3;
  BooleanQueryMessage bq = 4;
  bool withMetadata = 5;
}

message SimpleSequentialQueryMessage {
  string entity = 1;
  NearestNeighbourQueryMessage nnq = 2;
  BooleanQueryMessage bq = 3;
  bool withMetadata = 4;
}

message SimpleSpecifiedIndexQueryMessage {
  string index = 1;
  NearestNeighbourQueryMessage nnq = 2;
  BooleanQueryMessage bq = 3;
  bool withMetadata = 4;
}

message SimpleIndexQueryMessage {
  string entity = 1;
  IndexType indextype = 2;
  NearestNeighbourQueryMessage nnq = 3;
  BooleanQueryMessage bq = 4;
  bool withMetadata = 5;
}

message TimedQueryMessage {
  string entity = 1;
  NearestNeighbourQueryMessage nnq = 2;
  BooleanQueryMessage bq = 3;
  int64 time = 4;
  bool withMetadata = 5;
}

message QueryResponseInfoMessage {
  double confidence = 1;
  IndexType indextype = 2;
  QueryResponseListMessage queryResponseList = 3;
}

message QueryResponseMessage {
  int64 id = 1;
  float distance = 2;
  map<string, string> metadata = 3;
}

message QueryResponseListMessage {
  repeated QueryResponseMessage responses = 1;
}

message CompoundQueryMessage {
  string entity = 1;
  NearestNeighbourQueryMessage nnq = 2;
  ExpressionQueryMessage indexFilterExpression = 3;
  bool withMetadata = 4;
}

//experimental
message ExpressionQueryMessage {
  enum Operation {
      UNION = 0;
      INTERSECT = 1;
      EXCEPT = 2;
    }
   //Any is not yet supported
   //import "google/protobuf/any.proto";
   //google.protobuf.Any left = 1;
   //Operation operation = 2;
   //google.protobuf.Any right = 3;

   oneof left {
       SimpleSequentialQueryMessage lssqm = 2;
       SimpleIndexQueryMessage lsiqm = 3;
       ExpressionQueryMessage leqm = 4;
     }
   Operation operation = 1;
   oneof right {
       SimpleSequentialQueryMessage rssqm = 5;
       SimpleIndexQueryMessage rsiqm = 6;
       ExpressionQueryMessage reqm = 7;
     }
}